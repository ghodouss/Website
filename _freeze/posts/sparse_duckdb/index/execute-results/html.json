{
  "hash": "23bec13a8abd7c6ee77bf4341f546658",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Cutting DuckDB Storage in Half with SciPy-Style Sparse Arrays\"\nauthor: \"Kian Ghodoussi\"\ndate: \"2025-09-21\"\ncategories: [duckdb, sparse]\nexecute:\n  echo: false\nimage: \"sparse-box-plot.png\"\nimage-alt: \"Sparse vs Dense File Storage Ratios\"\n---\n\n\n::: {.subhead}\nI was surprised to discover that nearly three-quarters of our storage was near-zero float32s — and motivated to take advantage of this sparsity.\n:::\n\n<p align=\"center\">\n![](boxplot-review)\n</p>\n\n\n### Background \nAt Sturdy Statistics, we build [sparsity-inducing](https://sturdystatistics.com/articles/sparse-regression) hierarchical [mixture models](/posts/technology/index.qmd) for unsupervised and semi-supervised text organization.\nThese models are extensions of [topic models](https://www.cs.columbia.edu/~blei/papers/Blei2012.pdf), with the ability to add arbitrary levels of hierarchy or additional branches, and to embed metadata into the structure of the graph.\nOur models learn a set of high level \"topics\" from the data, and then annotate the original data with these high level topics. \nWe use [DuckDB](https://duckdb.org/) to store topic annotations at the paragraph and document level. \n\n\nBecause we explicitly model the [power-law](https://shiftleft.com/mirrors/www.hpl.hp.com/research/idl/papers/ranking/ranking.html) behavior of text data, our priors adopt a [rich-get-richer](https://www.ismll.uni-hildesheim.de/lehre/cmie-11w/script/lecture10.pdf) scheme. \nConsequently, most topic activations are near zero.\nThat means our data is inherently sparse — and ripe for storage optimization.\nThere are a number of [analytical benefits](https://sturdystatistics.com/features/#structure) to this sparsity, but for the purpose of this post, the primary benefit is some sweet storage and speed wins.\n\nOnce I saw how sparse our data really was, I wanted to see how much space we could actually save in practice.\n\n### Sparsity \n\nThe next steps were \n\n1. Write arrays into DuckDB in a sparse format\n2. Write a set of wrappers that enable me to operate on these sparse arrays as if they are standard DuckDB lists\n3. Benchmark performance and storage wins (I'm optimistic)\n\nFor (1), I decided to use SciPy style sparse arrays `(Dimension: int, indices: list(int8), Values: list(float32))`. For example:  `[7, 0, 0, 0, 23] => (5, [1, 5], [7, 23])`\n\n<details>\n<summary> Example Conversion in Numpy </summary>\n\n```py\nimport numpy as np\ndef numpy_to_sparse(x):\n    x = np.where(x < np.max(x)/3e3, 0.0, x).astype(np.uint8)\n    inds = np.where(x!=0)[0]\n    vals = x[inds]\n    dim = len(x)\n    vals = (dim, inds.astype(np.uint16), vals.astype(np.float32))\n    return vals\n\ndef numpy_from_sparse(vals):\n    dim = vals[0]\n    inds = vals[1]\n    data = vals[2]\n    arr = np.zeros(dim, dtype=np.float32)\n    arr[inds] = data\n    return arr\n```\n</details>\n\nWhen building wrapper functions, I had to choose between storing the sparse format in one column or splitting it into three.\nThe benefit of storing it in one column is that I could fully abstract away the fact that these arrays are sparse.\nHowever, because DuckDB is a [columnar data store](https://clickhouse.com/docs/faq/general/columnar-database), I opted to split out the **indices** and the **values** so I could flexibly access either component without reading both.\nOur data is sparse enough that the indices alone provide a mechanism to rapidly filter excerpts that contain a topic to some degree. \nIf I stored the indices in the same column as the values, I would have to read 5× as much data (int8 vs int8+float32). \nThe immediate performance benefit made the choice easy.\nI also fully removed the dimensionality parameter, opting to store it in the table metadata. \n\n>If my goal were to integrate this into DuckDB, I would have opted for the more ergonomic approach. \n\nI put together a [few helper functions](https://github.com/Sturdy-Statistics/duckdb-sparse-array-list-functions) that enabled me to perform all the operations.\nWe use these functions internally, and we also publicly [expose them in our API](https://sturdystatistics.com/docs/reference/SparseSQL.html). \n\n<details>\n<summary>Sparse SQL Functions</summary>\n```sql\nCREATE OR REPLACE TEMPORARY MACRO sparse_list_extract(position, inds, vals) AS  \n    COALESCE(vals[list_position(inds, position)], 0);\n\nCREATE OR REPLACE TEMPORARY MACRO sparse_list_select(positions, inds, vals) AS  \n    list_transform(positions, x-> sparse_list_extract(x, inds, vals));\n\nCREATE OR REPLACE TEMPORARY MACRO dense_x_sparse_dot_product(arr, inds, vals) AS \n    list_dot_product(list_select(arr, inds)::DOUBLE[], vals::DOUBLE[]);\n\nCREATE OR REPLACE TEMPORARY MACRO sparse_to_dense(K, inds, vals) AS \n    list_transform(\n        generate_series(1, K), \n        x-> coalesce(list_extract(vals, list_position(inds, x)), 0)\n    );\n```\n</details>\n\nThese helpers replace array indexing, multi-indexing and converting sparse lists to dense. I was actually surprised how rarely I actually needed to perform this conversion: instead, for operations such as [Hellinger distance](https://en.wikipedia.org/wiki/Hellinger_distance) or dot products, I can often restrict computation to the **overlap** in sparse indices instead (spoiler: performance wins are upcoming).\n\n\n### Benchmarking the Code\n\nMy first attempt was to benchmark DuckDB file sizes storing various levels of sparsity. \nI wanted a clear, granular understanding of how sparsity affects data at various levels of dimensionality and sparsity. \nI decided to put together some artificial data to benchmark the results…\n\n> Hint: this was a bad idea\n\nI used numpy to generate a matrix of **K×D** where K is the number of topics (embedding dimension in Neural terms) and D is the number of documents. I set the first S rows to be 1/K and the rest were zero. I took these matrices and created two DuckDB files: one with raw storage and the other sparsely encoded.\n\nI was shocked to see that there was **virtually no difference in the file size.**  I was stunned that a 512-dimensional array occupied nearly the same space in DuckDB as two 8-dimensional arrays.\n\nIn my eagerness to get an easy 75% reduction in file size, I completely overlooked the fact that DuckDB applies **Snappy compression** to its files. \nCompressing long runs of zeros and ones is trivial for a compressor, so my synthetic data didn’t reveal much.\nEven though the synthetic benchmarks didn’t deliver the expected 75% reduction, they exposed how compression interacts with sparsity — a key insight for real-world data.\nI re-ran the test with random values in random positions and saw a modest but real improvement: **~20%** average reduction.\n\n> Note: at this point in time my entire DuckDB file was a single database table consisting of a single list column, stored either raw or sparsely across two columns. \n\nThis was a solid win, albeit one much less than I hoped for. \nBut it was enough to see this project through to the next stage.\n\n### Real Data (or the only benchmark that mattered)\n\nI downloaded the DuckDB files from our [publicly hosted indices](https://platform.sturdystatistics.com/public/index) to migrate to our sparse format for storage and performance benchmarking.\nI repurposed my previous script to read the original DuckDB files, convert the relevant list fields to a sparse format, and write a new file. The result made me simultaneously excited, confused — and hesitant:\n\n::: {#aae90077 .cell execution_count=1}\n\n::: {.cell-output .cell-output-display}\n```{=html}\n<div>                            <div id=\"7a958431-0d3c-4685-807a-d23d563a30dc\" class=\"plotly-graph-div\" style=\"height:500px; width:600px;\"></div>            <script type=\"text/javascript\">                require([\"plotly\"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById(\"7a958431-0d3c-4685-807a-d23d563a30dc\")) {                    Plotly.newPlot(                        \"7a958431-0d3c-4685-807a-d23d563a30dc\",                        [{\"hovertemplate\":\"dim=48\\u003cbr\\u003eDense File Size Mb=%{x}\\u003cbr\\u003eSparse File Size Mb=%{y}\\u003cextra\\u003e\\u003c\\u002fextra\\u003e\",\"legendgroup\":\"48\",\"marker\":{\"color\":\"#2E91E5\",\"symbol\":\"circle\"},\"mode\":\"markers\",\"name\":\"48\",\"orientation\":\"v\",\"showlegend\":true,\"x\":[65.1168228075,59.4515835238,57.6930947826,50.6655179968,58.612533301,63.4094142555,82.1364452285,55.0759116989,63.8348671188,74.2439685738,77.3492585275,56.9705773553,55.1107395898,46.67761655,58.322585311,75.6474681682,56.3489883563,71.437638953,76.4453821354,70.4164242503,53.4143116938,61.0007033497,69.9292987864,81.4240312107,76.4203113875,65.8477172769,54.3526745731,56.2714715982,72.1135393653,55.6285536615,48.232140448,59.0571673446,51.817139853,68.9056155361,52.1796031072,43.4923420727,70.0530201896,43.544757981,58.7519934719,46.4496845782,79.7241692521,101.5544031773,108.8324511032,80.2492023762,90.0528509452,84.440783827,72.4534639519,92.2548545293,79.5454507976,70.1578127022,83.7719993465,102.938862533,111.9726188859,88.5297397481,80.4116452278,93.712008404,70.8592224291,56.96780068,70.6960672864,68.6136267319,94.8545706191,63.3301154551,75.360020054,83.0945867786,83.8009896471,89.4866825327,66.5839170472,107.5918914387,65.8396036152,54.1208018854,72.0682814581,77.5921674955,66.1485933901,76.4345757026,80.077201413,63.5096956576,97.4543194381,87.5192339921,78.1154293472,89.9793204119,64.0975145076,101.4802796105,70.2959478244,90.3057302699,91.2794497391,67.6133797872,58.6776800803],\"xaxis\":\"x\",\"y\":[34.4142759576,45.1867592235,44.5097356764,36.4276646,36.5317686085,51.0960219675,53.9945711202,43.6016250733,46.7406414314,46.7270338192,51.6659015511,33.2537416739,28.2059049331,27.1863762871,28.740091852,59.4867707684,30.515869491,30.9077025783,49.5387227398,68.9084704952,29.1557441615,41.8250500418,45.6291135084,70.2927326028,54.0785611898,46.9865950089,44.3262392966,45.18918771,46.8570277799,34.8531800785,39.7063157377,39.9547902597,37.1657312329,37.6317944761,36.3189333537,24.6733416438,52.574144728,28.2729965853,40.9637766913,25.708456437,49.4058877756,82.1406996609,68.4164270365,47.0404072855,55.7001631574,64.3102988561,52.879981201,73.6614864095,65.8975266227,38.6052440313,47.2845906802,66.9713979875,58.0923712737,72.0872534942,53.1859372241,56.9184330404,32.3387465936,38.788480929,51.9475937447,37.1714042149,64.4650218951,56.1748376108,55.1563599046,49.3677981761,59.9863495208,57.2159716914,46.2405262584,78.8731453602,52.464808421,46.9628415222,71.0216155554,46.0342548245,58.6142458747,65.9480963476,61.6947798143,49.6352728196,70.3514948686,57.3813399115,44.297994296,59.6644419688,39.9398353758,66.2293462896,51.6803201514,79.8046435901,61.572782873,48.8190850244,38.1195380881],\"yaxis\":\"y\",\"type\":\"scatter\"},{\"hovertemplate\":\"dim=96\\u003cbr\\u003eDense File Size Mb=%{x}\\u003cbr\\u003eSparse File Size Mb=%{y}\\u003cextra\\u003e\\u003c\\u002fextra\\u003e\",\"legendgroup\":\"96\",\"marker\":{\"color\":\"#E15F99\",\"symbol\":\"circle\"},\"mode\":\"markers\",\"name\":\"96\",\"orientation\":\"v\",\"showlegend\":true,\"x\":[89.0153307748,95.5919744517,111.6848038512,77.6925105345,85.6093435403,103.4265390669,83.7542299623,91.0499890115,101.9467057681,88.5831504753,160.1979285253,192.5421662379,145.0785793577,109.2700047837,148.405338766,242.9989398738,171.3096271353,212.1307266584,95.9166365829,79.7653579538,129.126384426,164.7791349049,160.897811794,180.7342027577,212.5965399819,148.8061207777,193.8886042203,134.5729472218,159.3789642987,78.14240234,125.4299376996,134.4068676503,135.1753836743,225.1393266893,117.9273939601,96.7292731147,151.0437733235,168.5117197532,170.1984230729,126.4496858265,180.9452680511,165.0618032462,162.5242789489,180.3921941626,135.8281550665,172.8333310752,207.6462235879,166.683565665,166.5285371707,203.2430480374,108.1010831663,145.7414083111,205.3373052535,213.7987270896,207.7436798855,134.4613398479,156.42156563,225.0529784835,180.2248136483,205.1633278697,151.8771018998,144.6323835886,125.4195289462,150.7167632419,133.0240005409,110.3426590565,220.1428103613,178.0953539335,100.997913058,161.6328311019,182.728683554,195.0103318426,169.8633147658,212.2012904197,279.0587102792,196.9104842476,109.7708047944,239.5417991829,169.6763533629,174.7892187036,255.1559919065,196.6565426617,110.4353961718,171.4479349954,156.023012291,125.768860093,198.3043071223,163.9233492215,129.6582451293,98.9886301642,102.2064172428,107.8667761993,219.2420042783,179.9789189024,186.0636180144,202.9978683166,112.5561397806,158.2454612458,171.4087334013,169.3707065027,192.139712623,94.9696010299,131.2858878701,193.2199809647,153.4243670247,181.9166894354,151.4773367556,137.9873928244,146.4617244679,143.5061388134,193.1966377141,169.2603961122,149.6639211077,205.3013320897,195.0256729607,117.7045687162,148.8148117543,202.5027287056,189.9009336365,130.8088496549,144.5105648971,98.9165848486,196.524879661,131.0780092932,192.341432732,156.6981208267,131.035961341,209.1395911015,138.3424226444,117.2975605918,139.8022708109],\"xaxis\":\"x\",\"y\":[61.2694970563,69.1814552905,78.440652718,54.6382921527,36.9993077157,78.4472345238,61.7532184062,60.7448696648,74.1417869359,50.486356968,94.1540075182,107.1777716723,75.8200286163,71.2050772831,104.9177072214,142.3621991136,91.5701486641,101.2886311404,41.1804079364,41.5848310072,81.5628248253,89.5028355235,91.7665364024,114.6006035996,106.9380453773,79.7848168102,95.9009497079,76.6660907183,73.8884971241,51.1733586616,61.7910753811,87.2378032907,77.0844977397,97.8908334436,54.5882795978,55.2177087143,81.056315478,104.655535819,116.658984478,98.5579925558,112.3964743746,98.3679992038,99.0535557409,107.2158501265,57.811174145,97.6097598982,112.0454846526,93.963975069,83.7759829047,140.0143998318,70.5650147863,55.7114814813,111.1561445046,148.4459882284,132.2526660478,73.2000085456,112.325660007,118.6164310936,103.9993418267,148.5743771886,116.6019981431,94.0035124159,69.1976837828,92.6445636993,80.9194135013,84.519927979,183.9701737333,105.6835398331,64.8249601516,116.5712904971,115.1058363305,87.4115794002,140.873993045,114.080097525,166.6022913961,91.5459940302,41.6863133396,140.7196996527,97.3194545354,106.9784871265,174.9991750156,146.2645212812,85.1802698405,114.9759523908,92.4469731645,48.656483945,116.6413836055,94.5251386857,77.3491305864,49.1250981068,61.10119871,68.2287483446,124.136016076,94.6827691738,121.1675503114,139.5150747837,55.0755204505,93.1506992472,111.5210161004,94.5604977562,95.2483674141,45.1083268581,50.3981590913,116.6469733535,77.2383024569,103.4961777365,75.9740740005,44.1113104122,88.5709521269,65.6578973063,116.2034633622,86.5698545418,101.2761841564,98.5899458069,116.3627493016,61.1644072634,79.2398113853,144.7577936685,114.0749835532,55.6885350828,81.3099662337,66.35630453,101.3234772226,55.5415878079,118.1869523344,85.536889877,79.5249136802,103.5623284909,71.1547894828,48.4856792294,79.880089011],\"yaxis\":\"y\",\"type\":\"scatter\"},{\"hovertemplate\":\"dim=192\\u003cbr\\u003eDense File Size Mb=%{x}\\u003cbr\\u003eSparse File Size Mb=%{y}\\u003cextra\\u003e\\u003c\\u002fextra\\u003e\",\"legendgroup\":\"192\",\"marker\":{\"color\":\"#1CA71C\",\"symbol\":\"circle\"},\"mode\":\"markers\",\"name\":\"192\",\"orientation\":\"v\",\"showlegend\":true,\"x\":[196.7955831863,218.0515030176,301.7576173003,190.1212928976,271.7291756596,312.6678849479,289.0281404499,285.4183153459,180.2291435049,213.9303828498,241.8709696262,201.9425882497,325.448861855,206.9470315903,147.8650391368,216.8954746595,285.1546600785,327.3154551644,333.6163923122,237.3841942899,230.4044730558,219.6815092207,370.2046969343,241.1320938474,180.6666852361,265.6244305051,282.7168835889,236.7333691581,213.7883665287,420.1579285293,307.7383382092,282.8057019443,60.1627759123,72.5362581287,92.1376839589,56.3513710023,98.4864744758,124.8520415384,81.648722677,110.5659044585,66.9982167316,57.3570895934,78.6090468299,71.2369148307,105.270057205,77.4874427424,52.2424536874,113.9362889189,86.6345500638,81.0743457933,104.9884679796,56.214937866,84.6653068049,110.4731709149,65.2449645807,89.0157269413,78.2127968984,67.4420840364,65.3525770464],\"xaxis\":\"x\",\"y\":[100.5234328947,133.7736372177,119.5213225531,100.6268018506,131.6354537061,239.8610584701,189.1375427048,119.4999747255,102.198156023,134.7235533871,143.6635820353,134.4815152124,200.6716047346,130.284698405,113.4943938188,92.1767389853,112.7822304217,208.2803833809,162.6995994714,142.4950835204,109.2740374745,131.1574323367,182.3882597825,127.5396060743,100.9744919958,216.5009484583,209.5869791228,113.5393805603,132.2904164574,280.8254938709,156.2932223201,119.6789436292,33.7627616782,25.8992627053,45.6248459006,31.1060379023,48.1236592093,46.7841942042,42.9720588716,57.0844160533,26.2857528047,24.0637887625,45.0798474682,35.9410939771,51.8954555843,44.0696339092,26.1452593935,58.5432297881,40.5524140804,32.2515318625,48.7296703513,27.9544616524,54.7058245818,67.1744427743,48.9998815246,43.9023410907,41.4942570877,30.2757618097,33.478392634],\"yaxis\":\"y\",\"type\":\"scatter\"},{\"hovertemplate\":\"dim=512\\u003cbr\\u003eDense File Size Mb=%{x}\\u003cbr\\u003eSparse File Size Mb=%{y}\\u003cextra\\u003e\\u003c\\u002fextra\\u003e\",\"legendgroup\":\"512\",\"marker\":{\"color\":\"#FB0D0D\",\"symbol\":\"circle\"},\"mode\":\"markers\",\"name\":\"512\",\"orientation\":\"v\",\"showlegend\":true,\"x\":[542.5670616767,665.3918033936,593.1329273257,563.0680696895,681.6447976039,656.5570259038,385.5357244583,752.9499334151,508.450908793,782.2792641218,655.5927765715,610.8062460269,595.0314237591,458.1743881906,818.8991376945,839.7938850387,429.6540004435,353.0514457462,845.7682790124,636.9045456909,730.9865259976,587.4360843583,371.3671998404,624.5433293102,619.8181318613],\"xaxis\":\"x\",\"y\":[172.9127515395,275.1541567973,255.8524176537,191.6731520509,381.3937234172,285.7864968445,182.9376700975,342.5789929428,132.6178774994,321.6172049082,232.4255071781,219.9582697399,244.7464866474,164.8003559486,226.8144043454,239.6643919404,183.4464654395,173.8973206897,387.1338795693,229.3126314075,292.6164570185,189.499069222,140.269175529,250.8387319609,243.638793753],\"yaxis\":\"y\",\"type\":\"scatter\"}],                        {\"autosize\":true,\"font\":{\"family\":\"Charter\"},\"height\":500,\"legend\":{\"title\":{\"text\":\"dim\"},\"tracegroupgap\":0},\"margin\":{\"b\":0,\"l\":0,\"pad\":0,\"r\":0,\"t\":30},\"paper_bgcolor\":\"rgba(0, 0, 0, 0)\",\"plot_bgcolor\":\"rgba(0, 0, 0, 0)\",\"shapes\":[{\"line\":{\"color\":\"black\",\"dash\":\"dash\",\"width\":2},\"type\":\"line\",\"x0\":1,\"x1\":895.7682790124,\"y0\":1,\"y1\":895.7682790124}],\"template\":{\"data\":{\"barpolar\":[{\"marker\":{\"line\":{\"color\":\"white\",\"width\":0.5},\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"barpolar\"}],\"bar\":[{\"error_x\":{\"color\":\"rgb(36,36,36)\"},\"error_y\":{\"color\":\"rgb(36,36,36)\"},\"marker\":{\"line\":{\"color\":\"white\",\"width\":0.5},\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"bar\"}],\"carpet\":[{\"aaxis\":{\"endlinecolor\":\"rgb(36,36,36)\",\"gridcolor\":\"white\",\"linecolor\":\"white\",\"minorgridcolor\":\"white\",\"startlinecolor\":\"rgb(36,36,36)\"},\"baxis\":{\"endlinecolor\":\"rgb(36,36,36)\",\"gridcolor\":\"white\",\"linecolor\":\"white\",\"minorgridcolor\":\"white\",\"startlinecolor\":\"rgb(36,36,36)\"},\"type\":\"carpet\"}],\"choropleth\":[{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"},\"type\":\"choropleth\"}],\"contourcarpet\":[{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"},\"type\":\"contourcarpet\"}],\"contour\":[{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"},\"colorscale\":[[0.0,\"#440154\"],[0.1111111111111111,\"#482878\"],[0.2222222222222222,\"#3e4989\"],[0.3333333333333333,\"#31688e\"],[0.4444444444444444,\"#26828e\"],[0.5555555555555556,\"#1f9e89\"],[0.6666666666666666,\"#35b779\"],[0.7777777777777778,\"#6ece58\"],[0.8888888888888888,\"#b5de2b\"],[1.0,\"#fde725\"]],\"type\":\"contour\"}],\"heatmapgl\":[{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"},\"colorscale\":[[0.0,\"#440154\"],[0.1111111111111111,\"#482878\"],[0.2222222222222222,\"#3e4989\"],[0.3333333333333333,\"#31688e\"],[0.4444444444444444,\"#26828e\"],[0.5555555555555556,\"#1f9e89\"],[0.6666666666666666,\"#35b779\"],[0.7777777777777778,\"#6ece58\"],[0.8888888888888888,\"#b5de2b\"],[1.0,\"#fde725\"]],\"type\":\"heatmapgl\"}],\"heatmap\":[{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"},\"colorscale\":[[0.0,\"#440154\"],[0.1111111111111111,\"#482878\"],[0.2222222222222222,\"#3e4989\"],[0.3333333333333333,\"#31688e\"],[0.4444444444444444,\"#26828e\"],[0.5555555555555556,\"#1f9e89\"],[0.6666666666666666,\"#35b779\"],[0.7777777777777778,\"#6ece58\"],[0.8888888888888888,\"#b5de2b\"],[1.0,\"#fde725\"]],\"type\":\"heatmap\"}],\"histogram2dcontour\":[{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"},\"colorscale\":[[0.0,\"#440154\"],[0.1111111111111111,\"#482878\"],[0.2222222222222222,\"#3e4989\"],[0.3333333333333333,\"#31688e\"],[0.4444444444444444,\"#26828e\"],[0.5555555555555556,\"#1f9e89\"],[0.6666666666666666,\"#35b779\"],[0.7777777777777778,\"#6ece58\"],[0.8888888888888888,\"#b5de2b\"],[1.0,\"#fde725\"]],\"type\":\"histogram2dcontour\"}],\"histogram2d\":[{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"},\"colorscale\":[[0.0,\"#440154\"],[0.1111111111111111,\"#482878\"],[0.2222222222222222,\"#3e4989\"],[0.3333333333333333,\"#31688e\"],[0.4444444444444444,\"#26828e\"],[0.5555555555555556,\"#1f9e89\"],[0.6666666666666666,\"#35b779\"],[0.7777777777777778,\"#6ece58\"],[0.8888888888888888,\"#b5de2b\"],[1.0,\"#fde725\"]],\"type\":\"histogram2d\"}],\"histogram\":[{\"marker\":{\"line\":{\"color\":\"white\",\"width\":0.6}},\"type\":\"histogram\"}],\"mesh3d\":[{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"},\"type\":\"mesh3d\"}],\"parcoords\":[{\"line\":{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"}},\"type\":\"parcoords\"}],\"pie\":[{\"automargin\":true,\"type\":\"pie\"}],\"scatter3d\":[{\"line\":{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"}},\"marker\":{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"}},\"type\":\"scatter3d\"}],\"scattercarpet\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"}},\"type\":\"scattercarpet\"}],\"scattergeo\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"}},\"type\":\"scattergeo\"}],\"scattergl\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"}},\"type\":\"scattergl\"}],\"scattermapbox\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"}},\"type\":\"scattermapbox\"}],\"scatterpolargl\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"}},\"type\":\"scatterpolargl\"}],\"scatterpolar\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"}},\"type\":\"scatterpolar\"}],\"scatter\":[{\"fillpattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2},\"type\":\"scatter\"}],\"scatterternary\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"}},\"type\":\"scatterternary\"}],\"surface\":[{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"},\"colorscale\":[[0.0,\"#440154\"],[0.1111111111111111,\"#482878\"],[0.2222222222222222,\"#3e4989\"],[0.3333333333333333,\"#31688e\"],[0.4444444444444444,\"#26828e\"],[0.5555555555555556,\"#1f9e89\"],[0.6666666666666666,\"#35b779\"],[0.7777777777777778,\"#6ece58\"],[0.8888888888888888,\"#b5de2b\"],[1.0,\"#fde725\"]],\"type\":\"surface\"}],\"table\":[{\"cells\":{\"fill\":{\"color\":\"rgb(237,237,237)\"},\"line\":{\"color\":\"white\"}},\"header\":{\"fill\":{\"color\":\"rgb(217,217,217)\"},\"line\":{\"color\":\"white\"}},\"type\":\"table\"}]},\"layout\":{\"annotationdefaults\":{\"arrowhead\":0,\"arrowwidth\":1},\"autotypenumbers\":\"strict\",\"coloraxis\":{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"}},\"colorscale\":{\"diverging\":[[0.0,\"rgb(103,0,31)\"],[0.1,\"rgb(178,24,43)\"],[0.2,\"rgb(214,96,77)\"],[0.3,\"rgb(244,165,130)\"],[0.4,\"rgb(253,219,199)\"],[0.5,\"rgb(247,247,247)\"],[0.6,\"rgb(209,229,240)\"],[0.7,\"rgb(146,197,222)\"],[0.8,\"rgb(67,147,195)\"],[0.9,\"rgb(33,102,172)\"],[1.0,\"rgb(5,48,97)\"]],\"sequential\":[[0.0,\"#440154\"],[0.1111111111111111,\"#482878\"],[0.2222222222222222,\"#3e4989\"],[0.3333333333333333,\"#31688e\"],[0.4444444444444444,\"#26828e\"],[0.5555555555555556,\"#1f9e89\"],[0.6666666666666666,\"#35b779\"],[0.7777777777777778,\"#6ece58\"],[0.8888888888888888,\"#b5de2b\"],[1.0,\"#fde725\"]],\"sequentialminus\":[[0.0,\"#440154\"],[0.1111111111111111,\"#482878\"],[0.2222222222222222,\"#3e4989\"],[0.3333333333333333,\"#31688e\"],[0.4444444444444444,\"#26828e\"],[0.5555555555555556,\"#1f9e89\"],[0.6666666666666666,\"#35b779\"],[0.7777777777777778,\"#6ece58\"],[0.8888888888888888,\"#b5de2b\"],[1.0,\"#fde725\"]]},\"colorway\":[\"#1F77B4\",\"#FF7F0E\",\"#2CA02C\",\"#D62728\",\"#9467BD\",\"#8C564B\",\"#E377C2\",\"#7F7F7F\",\"#BCBD22\",\"#17BECF\"],\"font\":{\"color\":\"rgb(36,36,36)\"},\"geo\":{\"bgcolor\":\"white\",\"lakecolor\":\"white\",\"landcolor\":\"white\",\"showlakes\":true,\"showland\":true,\"subunitcolor\":\"white\"},\"hoverlabel\":{\"align\":\"left\"},\"hovermode\":\"closest\",\"mapbox\":{\"style\":\"light\"},\"margin\":{\"b\":0,\"l\":0,\"pad\":0,\"r\":0,\"t\":30},\"paper_bgcolor\":\"white\",\"plot_bgcolor\":\"white\",\"polar\":{\"angularaxis\":{\"gridcolor\":\"rgb(232,232,232)\",\"linecolor\":\"rgb(36,36,36)\",\"showgrid\":false,\"showline\":true,\"ticks\":\"outside\"},\"bgcolor\":\"white\",\"radialaxis\":{\"gridcolor\":\"rgb(232,232,232)\",\"linecolor\":\"rgb(36,36,36)\",\"showgrid\":false,\"showline\":true,\"ticks\":\"outside\"}},\"scene\":{\"xaxis\":{\"backgroundcolor\":\"white\",\"gridcolor\":\"rgb(232,232,232)\",\"gridwidth\":2,\"linecolor\":\"rgb(36,36,36)\",\"showbackground\":true,\"showgrid\":false,\"showline\":true,\"ticks\":\"outside\",\"zeroline\":false,\"zerolinecolor\":\"rgb(36,36,36)\"},\"yaxis\":{\"backgroundcolor\":\"white\",\"gridcolor\":\"rgb(232,232,232)\",\"gridwidth\":2,\"linecolor\":\"rgb(36,36,36)\",\"showbackground\":true,\"showgrid\":false,\"showline\":true,\"ticks\":\"outside\",\"zeroline\":false,\"zerolinecolor\":\"rgb(36,36,36)\"},\"zaxis\":{\"backgroundcolor\":\"white\",\"gridcolor\":\"rgb(232,232,232)\",\"gridwidth\":2,\"linecolor\":\"rgb(36,36,36)\",\"showbackground\":true,\"showgrid\":false,\"showline\":true,\"ticks\":\"outside\",\"zeroline\":false,\"zerolinecolor\":\"rgb(36,36,36)\"}},\"shapedefaults\":{\"fillcolor\":\"black\",\"line\":{\"width\":0},\"opacity\":0.3},\"ternary\":{\"aaxis\":{\"gridcolor\":\"rgb(232,232,232)\",\"linecolor\":\"rgb(36,36,36)\",\"showgrid\":false,\"showline\":true,\"ticks\":\"outside\"},\"baxis\":{\"gridcolor\":\"rgb(232,232,232)\",\"linecolor\":\"rgb(36,36,36)\",\"showgrid\":false,\"showline\":true,\"ticks\":\"outside\"},\"bgcolor\":\"white\",\"caxis\":{\"gridcolor\":\"rgb(232,232,232)\",\"linecolor\":\"rgb(36,36,36)\",\"showgrid\":false,\"showline\":true,\"ticks\":\"outside\"}},\"title\":{\"x\":0.05},\"xaxis\":{\"automargin\":true,\"gridcolor\":\"rgb(232,232,232)\",\"linecolor\":\"rgb(36,36,36)\",\"showgrid\":false,\"showline\":true,\"ticks\":\"outside\",\"title\":{\"standoff\":15},\"zeroline\":false,\"zerolinecolor\":\"rgb(36,36,36)\"},\"yaxis\":{\"automargin\":true,\"gridcolor\":\"rgb(232,232,232)\",\"linecolor\":\"rgb(36,36,36)\",\"showgrid\":false,\"showline\":true,\"ticks\":\"outside\",\"title\":{\"standoff\":15},\"zeroline\":false,\"zerolinecolor\":\"rgb(36,36,36)\"}}},\"width\":600,\"xaxis\":{\"anchor\":\"y\",\"constrain\":\"domain\",\"domain\":[0.0,1.0],\"fixedrange\":true,\"range\":[1,895.7682790124],\"scaleanchor\":\"y\",\"scaleratio\":1,\"title\":{\"text\":\"Dense File Size Mb\"}},\"yaxis\":{\"anchor\":\"x\",\"constrain\":\"domain\",\"domain\":[0.0,1.0],\"fixedrange\":true,\"range\":[1,895.7682790124],\"title\":{\"text\":\"Sparse File Size Mb\"}}},                        {\"displayModeBar\": false, \"responsive\": true}                    ).then(function(){\n                            \nvar gd = document.getElementById('7a958431-0d3c-4685-807a-d23d563a30dc');\nvar x = new MutationObserver(function (mutations, observer) {{\n        var display = window.getComputedStyle(gd).display;\n        if (!display || display === 'none') {{\n            console.log([gd, 'removed!']);\n            Plotly.purge(gd);\n            observer.disconnect();\n        }}\n}});\n\n// Listen for the removal of the full notebook cells\nvar notebookContainer = gd.closest('#notebook-container');\nif (notebookContainer) {{\n    x.observe(notebookContainer, {childList: true});\n}}\n\n// Listen for the clearing of the current output cell\nvar outputEl = gd.closest('.output');\nif (outputEl) {{\n    x.observe(outputEl, {childList: true});\n}}\n\n                        })                };                });            </script>        </div>\n```\n:::\n:::\n\n\n<figcaption>\n**Figure 1:** Scatterplot showing file storage reduction across production datasets.\n</figcaption>\n\nThis is a major reduction in our file sizes, hitting an over 50% reduction for some of our largest files. \n\nWhat happened?\n\nMy initial test only measured a single column at a time.\nIn production, however, we store several sparsely-populated arrays alongside any arbitrary metadata provided by our users or by our integrations.\nSince this metadata is not sparse, I had expected its presence would reduce the impact of our total file size reduction. \nBut it had the *opposite effect:* we see a much more pronounced difference on real data.\nIt appears that the *additional columns handicapped the Snappy compression,* rendering our sparse storage much more effective at the *file level,* not just the array level.\n\nWhile we didn’t see the 75% reduction I had initially hoped for, compression still left us with a **52% average reduction** across all files.\nI’ll take it!\n\n### Scaling with Dimensionality \n\nAs expected, higher-dimensional arrays yielded larger storage reductions.\nSince our biggest datasets also have the highest topic counts, they benefited most.\n\n::: {#f557eb0e .cell execution_count=2}\n\n::: {.cell-output .cell-output-display}\n```{=html}\n<div>                            <div id=\"22526a52-7229-4fa6-a858-ececb717d6cc\" class=\"plotly-graph-div\" style=\"height:525px; width:100%;\"></div>            <script type=\"text/javascript\">                require([\"plotly\"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById(\"22526a52-7229-4fa6-a858-ececb717d6cc\")) {                    Plotly.newPlot(                        \"22526a52-7229-4fa6-a858-ececb717d6cc\",                        [{\"alignmentgroup\":\"True\",\"boxpoints\":\"all\",\"fillcolor\":\"rgba(0,0,0,0)\",\"hovertemplate\":\"dim=48\\u003cbr\\u003eDimensions=%{x}\\u003cbr\\u003eSparse to Dense Ratio=%{y}\\u003cextra\\u003e\\u003c\\u002fextra\\u003e\",\"legendgroup\":\"48\",\"marker\":{\"color\":\"#2E91E5\"},\"name\":\"48\",\"notched\":false,\"offsetgroup\":\"48\",\"orientation\":\"v\",\"showlegend\":false,\"x\":[\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\",\"48\"],\"x0\":\" \",\"xaxis\":\"x\",\"y\":[0.5285005390901265,0.7600598090950862,0.7714915596766349,0.7189833646287944,0.6232757151255349,0.8058112910744644,0.6573765271919118,0.79166415458849,0.732211776119362,0.6293714454764414,0.6679560028714588,0.5837002750825447,0.5118041445831077,0.5824285449103549,0.4927780841460648,0.786368297695474,0.5415513282695559,0.4326529128242142,0.6480276683300118,0.9785851983943424,0.5458414278299915,0.6856486523119031,0.6525035185577187,0.863292219233218,0.7076464385965009,0.7135645236009318,0.8155300478725247,0.8030567963935299,0.6497674111173488,0.6265339971012326,0.8232335403092497,0.6765443053941755,0.7172478322488549,0.5461353792911771,0.6960369797962018,0.5673031266643922,0.7504907652190719,0.6492858818422285,0.6972321153816206,0.5534689130928054,0.6197102865929031,0.8088344482463616,0.6286399538279658,0.5861791256812674,0.6185274821703901,0.7616023435767391,0.7298475230405225,0.7984564799904944,0.8284260880031146,0.550262936434012,0.5644438601091541,0.6505939189490305,0.5188087217366603,0.814271607476934,0.6614208311921531,0.6073760877583592,0.4563802069089504,0.6808842971994473,0.7348017469522425,0.541749590939757,0.6796195636577923,0.8870161882244952,0.7319047933516624,0.5941156950167791,0.7158191063543827,0.6393797386610268,0.6944699006761801,0.7330770405234266,0.7968579022381562,0.867741051243903,0.9854767467528899,0.5932848161145877,0.8860996564058818,0.8628045062250108,0.7704412582566137,0.781538508501108,0.7218920133477009,0.655642620417354,0.5670837972240862,0.6630906045486116,0.6231105165718144,0.6526326744841503,0.7351820659776572,0.8837162752749463,0.6745525202988268,0.7220329049967418,0.6496428971958959],\"y0\":\" \",\"yaxis\":\"y\",\"type\":\"box\"},{\"alignmentgroup\":\"True\",\"boxpoints\":\"all\",\"fillcolor\":\"rgba(0,0,0,0)\",\"hovertemplate\":\"dim=96\\u003cbr\\u003eDimensions=%{x}\\u003cbr\\u003eSparse to Dense Ratio=%{y}\\u003cextra\\u003e\\u003c\\u002fextra\\u003e\",\"legendgroup\":\"96\",\"marker\":{\"color\":\"#E15F99\"},\"name\":\"96\",\"notched\":false,\"offsetgroup\":\"96\",\"orientation\":\"v\",\"showlegend\":false,\"x\":[\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\",\"96\"],\"x0\":\" \",\"xaxis\":\"x\",\"y\":[0.6883027510317944,0.7237161454956189,0.7023395306536788,0.70326331041185,0.4321877284140467,0.7584826412209106,0.7373146220077095,0.667159549652748,0.7272602520826092,0.5699318289890505,0.5877354868751021,0.5566457143723728,0.5226135309014927,0.6516433986074263,0.7069672027556254,0.585855227136114,0.5345300798056031,0.47748212970348186,0.4293354041955808,0.5213394896476975,0.6316511159811974,0.5431684999144784,0.5703404874137763,0.6340836535143184,0.5030093405396178,0.5361662302143455,0.4946188049243754,0.5696991282500541,0.46360256793752225,0.6548731179128987,0.4926341869760576,0.6490576323650028,0.5702554388558807,0.4348011290745873,0.4628973622216192,0.5708479650087284,0.5366412245567818,0.6210579060748836,0.6854292911282275,0.7794245743799646,0.6211628277720895,0.5959464713776208,0.6094692828758458,0.5943486115028842,0.42561996161028826,0.5647623597310051,0.5395979889090992,0.5637266919154372,0.5030728326090169,0.6889012991284952,0.6527688041547608,0.3822625438226734,0.5413343881540265,0.6943258748504542,0.6366146306866827,0.5443944603586607,0.7180957405367967,0.5270600366761931,0.5770534019230542,0.7241760929270954,0.7677391567560162,0.6499478891483152,0.5517297374995169,0.6146931615735783,0.6083068707320995,0.7659769005178887,0.8356855871484823,0.593409864428927,0.641844550930206,0.7212104725407467,0.6299275739951571,0.44824076024214493,0.8293373600958559,0.5376032223902499,0.5970151988067792,0.46491173072881103,0.3797577454012312,0.5874536307763754,0.5735593240105492,0.6120428246087048,0.6858517164657734,0.7437561918944782,0.7713131187394702,0.6706173066119743,0.5925213967288125,0.38687226638629685,0.5881938990541636,0.5766423095588032,0.5965616032305896,0.49627010723668413,0.5978215493538819,0.6325279270285893,0.5662054426323573,0.5260769969684345,0.6512157057056823,0.6872735952384936,0.48931600317722274,0.5886468939700621,0.6506145508893552,0.5583049141658541,0.4957245231285848,0.4749764805676945,0.3838810089106161,0.6037003666551992,0.5034291746138689,0.5689207409046012,0.5015540649693347,0.31967638136576126,0.6047378757056222,0.4575267500693785,0.6014776692654582,0.5114596002978407,0.6766907041244792,0.4802206824640778,0.5966534945635003,0.5196434423108487,0.5324726111008932,0.7148436694843258,0.6007078605077176,0.42572452268877475,0.5626575904093757,0.6708309292275285,0.5155758263146133,0.4237292594493297,0.6144643442428572,0.545870553046385,0.6068938088930352,0.4951828008530386,0.5143381771309489,0.41335624530276477,0.5713790523406288],\"y0\":\" \",\"yaxis\":\"y\",\"type\":\"box\"},{\"alignmentgroup\":\"True\",\"boxpoints\":\"all\",\"fillcolor\":\"rgba(0,0,0,0)\",\"hovertemplate\":\"dim=192\\u003cbr\\u003eDimensions=%{x}\\u003cbr\\u003eSparse to Dense Ratio=%{y}\\u003cextra\\u003e\\u003c\\u002fextra\\u003e\",\"legendgroup\":\"192\",\"marker\":{\"color\":\"#1CA71C\"},\"name\":\"192\",\"notched\":false,\"offsetgroup\":\"192\",\"orientation\":\"v\",\"showlegend\":false,\"x\":[\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\",\"192\"],\"x0\":\" \",\"xaxis\":\"x\",\"y\":[0.5108012652882443,0.6134955979042368,0.39608386234756093,0.5292768648738253,0.4844362162677816,0.7671432533279462,0.6543914457962097,0.41868362435212797,0.5670456732777042,0.6297541826103732,0.5939678592157016,0.6659393463161666,0.6165994976624221,0.6295557728169254,0.7675539429830918,0.42498230601632647,0.39551249273167155,0.6363292050364302,0.4876846678419352,0.6002719934520204,0.47427046890724084,0.5970344650397248,0.492668681118512,0.528920078780609,0.5588993447455122,0.8150641416778235,0.741331668849185,0.4796086878841059,0.6187914646873017,0.6683808035085465,0.507876994558449,0.42318433753776075,0.5611902237924723,0.35705264337384657,0.49518116735983886,0.552001439344402,0.4886321646240358,0.3747170941518875,0.5263041167416205,0.5162931224853875,0.39233511109710195,0.419543406631793,0.5734689490097377,0.504529064215046,0.4929745168014892,0.5687325887848114,0.5004600195454793,0.5138242639250006,0.4680859316581677,0.3978019378007152,0.4641430748448346,0.4972781739799353,0.6461421643207689,0.6080611447827999,0.7510139953251591,0.4931975797900375,0.5305302806342788,0.4489149800495414,0.5122734886220403],\"y0\":\" \",\"yaxis\":\"y\",\"type\":\"box\"},{\"alignmentgroup\":\"True\",\"boxpoints\":\"all\",\"fillcolor\":\"rgba(0,0,0,0)\",\"hovertemplate\":\"dim=512\\u003cbr\\u003eDimensions=%{x}\\u003cbr\\u003eSparse to Dense Ratio=%{y}\\u003cextra\\u003e\\u003c\\u002fextra\\u003e\",\"legendgroup\":\"512\",\"marker\":{\"color\":\"#FB0D0D\"},\"name\":\"512\",\"notched\":false,\"offsetgroup\":\"512\",\"orientation\":\"v\",\"showlegend\":false,\"x\":[\"512\",\"512\",\"512\",\"512\",\"512\",\"512\",\"512\",\"512\",\"512\",\"512\",\"512\",\"512\",\"512\",\"512\",\"512\",\"512\",\"512\",\"512\",\"512\",\"512\",\"512\",\"512\",\"512\",\"512\",\"512\"],\"x0\":\" \",\"xaxis\":\"x\",\"y\":[0.318693786912066,0.4135220112330385,0.43135763648678166,0.34040849120888145,0.5595197451192546,0.43528054010402745,0.47450251297603613,0.4549824334122583,0.2608272995601848,0.41112837788082357,0.35452725454602574,0.36011136292508217,0.41131691012420585,0.3596891493638951,0.2769747749203465,0.2853847785868977,0.4269632430982646,0.4925551864605888,0.45773043181680284,0.3600423846225602,0.4003034893415542,0.32258670222651353,0.37771018977788706,0.40163543534753327,0.3930811010987338],\"y0\":\" \",\"yaxis\":\"y\",\"type\":\"box\"}],                        {\"autosize\":true,\"boxmode\":\"group\",\"font\":{\"family\":\"Charter\"},\"legend\":{\"title\":{\"text\":\"dim\"},\"tracegroupgap\":0},\"margin\":{\"b\":0,\"l\":0,\"pad\":0,\"r\":0,\"t\":30},\"paper_bgcolor\":\"rgba(0, 0, 0, 0)\",\"plot_bgcolor\":\"rgba(0, 0, 0, 0)\",\"template\":{\"data\":{\"barpolar\":[{\"marker\":{\"line\":{\"color\":\"white\",\"width\":0.5},\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"barpolar\"}],\"bar\":[{\"error_x\":{\"color\":\"rgb(36,36,36)\"},\"error_y\":{\"color\":\"rgb(36,36,36)\"},\"marker\":{\"line\":{\"color\":\"white\",\"width\":0.5},\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"bar\"}],\"carpet\":[{\"aaxis\":{\"endlinecolor\":\"rgb(36,36,36)\",\"gridcolor\":\"white\",\"linecolor\":\"white\",\"minorgridcolor\":\"white\",\"startlinecolor\":\"rgb(36,36,36)\"},\"baxis\":{\"endlinecolor\":\"rgb(36,36,36)\",\"gridcolor\":\"white\",\"linecolor\":\"white\",\"minorgridcolor\":\"white\",\"startlinecolor\":\"rgb(36,36,36)\"},\"type\":\"carpet\"}],\"choropleth\":[{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"},\"type\":\"choropleth\"}],\"contourcarpet\":[{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"},\"type\":\"contourcarpet\"}],\"contour\":[{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"},\"colorscale\":[[0.0,\"#440154\"],[0.1111111111111111,\"#482878\"],[0.2222222222222222,\"#3e4989\"],[0.3333333333333333,\"#31688e\"],[0.4444444444444444,\"#26828e\"],[0.5555555555555556,\"#1f9e89\"],[0.6666666666666666,\"#35b779\"],[0.7777777777777778,\"#6ece58\"],[0.8888888888888888,\"#b5de2b\"],[1.0,\"#fde725\"]],\"type\":\"contour\"}],\"heatmapgl\":[{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"},\"colorscale\":[[0.0,\"#440154\"],[0.1111111111111111,\"#482878\"],[0.2222222222222222,\"#3e4989\"],[0.3333333333333333,\"#31688e\"],[0.4444444444444444,\"#26828e\"],[0.5555555555555556,\"#1f9e89\"],[0.6666666666666666,\"#35b779\"],[0.7777777777777778,\"#6ece58\"],[0.8888888888888888,\"#b5de2b\"],[1.0,\"#fde725\"]],\"type\":\"heatmapgl\"}],\"heatmap\":[{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"},\"colorscale\":[[0.0,\"#440154\"],[0.1111111111111111,\"#482878\"],[0.2222222222222222,\"#3e4989\"],[0.3333333333333333,\"#31688e\"],[0.4444444444444444,\"#26828e\"],[0.5555555555555556,\"#1f9e89\"],[0.6666666666666666,\"#35b779\"],[0.7777777777777778,\"#6ece58\"],[0.8888888888888888,\"#b5de2b\"],[1.0,\"#fde725\"]],\"type\":\"heatmap\"}],\"histogram2dcontour\":[{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"},\"colorscale\":[[0.0,\"#440154\"],[0.1111111111111111,\"#482878\"],[0.2222222222222222,\"#3e4989\"],[0.3333333333333333,\"#31688e\"],[0.4444444444444444,\"#26828e\"],[0.5555555555555556,\"#1f9e89\"],[0.6666666666666666,\"#35b779\"],[0.7777777777777778,\"#6ece58\"],[0.8888888888888888,\"#b5de2b\"],[1.0,\"#fde725\"]],\"type\":\"histogram2dcontour\"}],\"histogram2d\":[{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"},\"colorscale\":[[0.0,\"#440154\"],[0.1111111111111111,\"#482878\"],[0.2222222222222222,\"#3e4989\"],[0.3333333333333333,\"#31688e\"],[0.4444444444444444,\"#26828e\"],[0.5555555555555556,\"#1f9e89\"],[0.6666666666666666,\"#35b779\"],[0.7777777777777778,\"#6ece58\"],[0.8888888888888888,\"#b5de2b\"],[1.0,\"#fde725\"]],\"type\":\"histogram2d\"}],\"histogram\":[{\"marker\":{\"line\":{\"color\":\"white\",\"width\":0.6}},\"type\":\"histogram\"}],\"mesh3d\":[{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"},\"type\":\"mesh3d\"}],\"parcoords\":[{\"line\":{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"}},\"type\":\"parcoords\"}],\"pie\":[{\"automargin\":true,\"type\":\"pie\"}],\"scatter3d\":[{\"line\":{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"}},\"marker\":{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"}},\"type\":\"scatter3d\"}],\"scattercarpet\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"}},\"type\":\"scattercarpet\"}],\"scattergeo\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"}},\"type\":\"scattergeo\"}],\"scattergl\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"}},\"type\":\"scattergl\"}],\"scattermapbox\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"}},\"type\":\"scattermapbox\"}],\"scatterpolargl\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"}},\"type\":\"scatterpolargl\"}],\"scatterpolar\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"}},\"type\":\"scatterpolar\"}],\"scatter\":[{\"fillpattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2},\"type\":\"scatter\"}],\"scatterternary\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"}},\"type\":\"scatterternary\"}],\"surface\":[{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"},\"colorscale\":[[0.0,\"#440154\"],[0.1111111111111111,\"#482878\"],[0.2222222222222222,\"#3e4989\"],[0.3333333333333333,\"#31688e\"],[0.4444444444444444,\"#26828e\"],[0.5555555555555556,\"#1f9e89\"],[0.6666666666666666,\"#35b779\"],[0.7777777777777778,\"#6ece58\"],[0.8888888888888888,\"#b5de2b\"],[1.0,\"#fde725\"]],\"type\":\"surface\"}],\"table\":[{\"cells\":{\"fill\":{\"color\":\"rgb(237,237,237)\"},\"line\":{\"color\":\"white\"}},\"header\":{\"fill\":{\"color\":\"rgb(217,217,217)\"},\"line\":{\"color\":\"white\"}},\"type\":\"table\"}]},\"layout\":{\"annotationdefaults\":{\"arrowhead\":0,\"arrowwidth\":1},\"autotypenumbers\":\"strict\",\"coloraxis\":{\"colorbar\":{\"outlinewidth\":1,\"tickcolor\":\"rgb(36,36,36)\",\"ticks\":\"outside\"}},\"colorscale\":{\"diverging\":[[0.0,\"rgb(103,0,31)\"],[0.1,\"rgb(178,24,43)\"],[0.2,\"rgb(214,96,77)\"],[0.3,\"rgb(244,165,130)\"],[0.4,\"rgb(253,219,199)\"],[0.5,\"rgb(247,247,247)\"],[0.6,\"rgb(209,229,240)\"],[0.7,\"rgb(146,197,222)\"],[0.8,\"rgb(67,147,195)\"],[0.9,\"rgb(33,102,172)\"],[1.0,\"rgb(5,48,97)\"]],\"sequential\":[[0.0,\"#440154\"],[0.1111111111111111,\"#482878\"],[0.2222222222222222,\"#3e4989\"],[0.3333333333333333,\"#31688e\"],[0.4444444444444444,\"#26828e\"],[0.5555555555555556,\"#1f9e89\"],[0.6666666666666666,\"#35b779\"],[0.7777777777777778,\"#6ece58\"],[0.8888888888888888,\"#b5de2b\"],[1.0,\"#fde725\"]],\"sequentialminus\":[[0.0,\"#440154\"],[0.1111111111111111,\"#482878\"],[0.2222222222222222,\"#3e4989\"],[0.3333333333333333,\"#31688e\"],[0.4444444444444444,\"#26828e\"],[0.5555555555555556,\"#1f9e89\"],[0.6666666666666666,\"#35b779\"],[0.7777777777777778,\"#6ece58\"],[0.8888888888888888,\"#b5de2b\"],[1.0,\"#fde725\"]]},\"colorway\":[\"#1F77B4\",\"#FF7F0E\",\"#2CA02C\",\"#D62728\",\"#9467BD\",\"#8C564B\",\"#E377C2\",\"#7F7F7F\",\"#BCBD22\",\"#17BECF\"],\"font\":{\"color\":\"rgb(36,36,36)\"},\"geo\":{\"bgcolor\":\"white\",\"lakecolor\":\"white\",\"landcolor\":\"white\",\"showlakes\":true,\"showland\":true,\"subunitcolor\":\"white\"},\"hoverlabel\":{\"align\":\"left\"},\"hovermode\":\"closest\",\"mapbox\":{\"style\":\"light\"},\"margin\":{\"b\":0,\"l\":0,\"pad\":0,\"r\":0,\"t\":30},\"paper_bgcolor\":\"white\",\"plot_bgcolor\":\"white\",\"polar\":{\"angularaxis\":{\"gridcolor\":\"rgb(232,232,232)\",\"linecolor\":\"rgb(36,36,36)\",\"showgrid\":false,\"showline\":true,\"ticks\":\"outside\"},\"bgcolor\":\"white\",\"radialaxis\":{\"gridcolor\":\"rgb(232,232,232)\",\"linecolor\":\"rgb(36,36,36)\",\"showgrid\":false,\"showline\":true,\"ticks\":\"outside\"}},\"scene\":{\"xaxis\":{\"backgroundcolor\":\"white\",\"gridcolor\":\"rgb(232,232,232)\",\"gridwidth\":2,\"linecolor\":\"rgb(36,36,36)\",\"showbackground\":true,\"showgrid\":false,\"showline\":true,\"ticks\":\"outside\",\"zeroline\":false,\"zerolinecolor\":\"rgb(36,36,36)\"},\"yaxis\":{\"backgroundcolor\":\"white\",\"gridcolor\":\"rgb(232,232,232)\",\"gridwidth\":2,\"linecolor\":\"rgb(36,36,36)\",\"showbackground\":true,\"showgrid\":false,\"showline\":true,\"ticks\":\"outside\",\"zeroline\":false,\"zerolinecolor\":\"rgb(36,36,36)\"},\"zaxis\":{\"backgroundcolor\":\"white\",\"gridcolor\":\"rgb(232,232,232)\",\"gridwidth\":2,\"linecolor\":\"rgb(36,36,36)\",\"showbackground\":true,\"showgrid\":false,\"showline\":true,\"ticks\":\"outside\",\"zeroline\":false,\"zerolinecolor\":\"rgb(36,36,36)\"}},\"shapedefaults\":{\"fillcolor\":\"black\",\"line\":{\"width\":0},\"opacity\":0.3},\"ternary\":{\"aaxis\":{\"gridcolor\":\"rgb(232,232,232)\",\"linecolor\":\"rgb(36,36,36)\",\"showgrid\":false,\"showline\":true,\"ticks\":\"outside\"},\"baxis\":{\"gridcolor\":\"rgb(232,232,232)\",\"linecolor\":\"rgb(36,36,36)\",\"showgrid\":false,\"showline\":true,\"ticks\":\"outside\"},\"bgcolor\":\"white\",\"caxis\":{\"gridcolor\":\"rgb(232,232,232)\",\"linecolor\":\"rgb(36,36,36)\",\"showgrid\":false,\"showline\":true,\"ticks\":\"outside\"}},\"title\":{\"x\":0.05},\"xaxis\":{\"automargin\":true,\"gridcolor\":\"rgb(232,232,232)\",\"linecolor\":\"rgb(36,36,36)\",\"showgrid\":false,\"showline\":true,\"ticks\":\"outside\",\"title\":{\"standoff\":15},\"zeroline\":false,\"zerolinecolor\":\"rgb(36,36,36)\"},\"yaxis\":{\"automargin\":true,\"gridcolor\":\"rgb(232,232,232)\",\"linecolor\":\"rgb(36,36,36)\",\"showgrid\":false,\"showline\":true,\"ticks\":\"outside\",\"title\":{\"standoff\":15},\"zeroline\":false,\"zerolinecolor\":\"rgb(36,36,36)\"}}},\"xaxis\":{\"anchor\":\"y\",\"domain\":[0.0,1.0],\"fixedrange\":true,\"title\":{\"text\":\"Dimensions\"}},\"yaxis\":{\"anchor\":\"x\",\"domain\":[0.0,1.0],\"fixedrange\":true,\"title\":{\"text\":\"Sparse to Dense Ratio\"}}},                        {\"displayModeBar\": false, \"responsive\": true}                    ).then(function(){\n                            \nvar gd = document.getElementById('22526a52-7229-4fa6-a858-ececb717d6cc');\nvar x = new MutationObserver(function (mutations, observer) {{\n        var display = window.getComputedStyle(gd).display;\n        if (!display || display === 'none') {{\n            console.log([gd, 'removed!']);\n            Plotly.purge(gd);\n            observer.disconnect();\n        }}\n}});\n\n// Listen for the removal of the full notebook cells\nvar notebookContainer = gd.closest('#notebook-container');\nif (notebookContainer) {{\n    x.observe(notebookContainer, {childList: true});\n}}\n\n// Listen for the clearing of the current output cell\nvar outputEl = gd.closest('.output');\nif (outputEl) {{\n    x.observe(outputEl, {childList: true});\n}}\n\n                        })                };                });            </script>        </div>\n```\n:::\n:::\n\n\n<figcaption>\n**Figure 2:** Boxplot of sparse vs. dense file storage ratios across production datasets.\n</figcaption>\n\nWhile the large dataset performance is a big win, we care most about general performance because we support so many use cases: \n\n- Our public [Deep Dive Search](https://platform.sturdystatistics.com/deepdive-search) creates a few hundred indices per day, split between our fast mode (48 dimensions) and our comprehensive mode (96 dimensions). \n- Our [production platform integrations](https://sturdystatistics.com/web/integration) have a slightly lower number of analyses trained per day with a default of 196 dimensions. \n- Our large-scale models tend to be a more deliberate effort, with maybe 1–2 of these trained per week. \n\nAt the moment, the total amount of storage is relatively evenly split between these three categories of models.\n(And we hope these numbers go up as we begin to announce Sturdy Statistics publicly!)\n\n\n### Performance \n\nI was both optimistic and concerned about the impact of sparse storage on performance. It turned out that we saw **no observable changes** in our search [query](https://sturdystatistics.com/docs/examples/quickstart/3.html) performance or our [topic retrieval](https://sturdystatistics.com/docs/examples/quickstart/3.html) performance.\nThis was likely because I was able to leverage my [dense_x_sparse_dot_product](https://sturdystatistics.com/docs/reference/SparseSQL.html#dense_x_sparse_dot_productdense_arr-inds-vals) SQL function to avoid casting any sparse arrays to dense.\n\nOur [TopicSearch](https://sturdystatistics.com/docs/examples/quickstart/1.html#section-2-0) and [TopicDiff](https://sturdystatistics.com/docs/examples/gallery/pharma_trends.html#topic-diff) however, initially saw significant performance degradations — about **2–5×** slower.\nThese APIs are much more analytical; they perform statistics over topic counts and expect dense arrays.\nI simply converted the sparse arrays to dense in my first pass, which obviously added overhead.\n\nHowever, our new sparse storage format opened the door to fully leveraging [UNNEST](https://duckdb.org/docs/stable/sql/query_syntax/unnest.html) much more efficiently due to the lower dimensionality of the arrays and the separate indices-and-values arrays. \n*Thanks to sparse storage, an UNNEST that previously expanded rows by 500× now expands them by just 3–8×.*\n\nThis not only sped up DuckDB queries but also let me [migrate a major portion](/posts/sql/index.qmd) of my Python post-processing directly into DuckDB.\nWith some tinkering I was able to see a solid **2–10x performance improvement**, with the larger improvements occurring on the larger datasets.\n\n**Sparse storage not only saved space—it made some operations up to 10× faster.**\n\n### Conclusion\n\n::: {.subhead}\nBenchmarks are just simulations; your own data tells the truth.\n:::\n\nMy main conclusion — one I’ve learned before and will likely learn again — is that the only benchmark that matters is the one on **your own data**. \nSimulations and estimates are helpful thought exercises; real workloads decide.\n\nSecond, while I initially tried to make sparse arrays feel “just like” dense arrays, embracing the different data structure is what unlocked most of the gains. \nUNNEST became *powerful* because indices and values live in separate columns. \nThe “right” architecture wasn’t what I first expected; it emerged from benchmarking real use cases and looking carefully at what we were actually storing.\n\nThese sparse array functions live in a small [GitHub repo](https://github.com/Sturdy-Statistics/duckdb-sparse-array-list-functions/tree/main), with [documentation with examples](https://sturdystatistics.com/docs/reference/SparseSQL.html).\nWe plan to reach out to the DuckDB team soon to explore official support for sparse-style arrays.\nIf you’re interested in running with this idea — for their own project or via open — I'd love to [chat](https://cal.com/kian-ghodoussi-xdeu67/30min) or help out however I can.\n\n\n\n\n<!-- Local Variables: -->\n<!-- fill-column: 100000 -->\n<!-- End: -->\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n<script type=\"text/javascript\">\nwindow.PlotlyConfig = {MathJaxConfig: 'local'};\nif (window.MathJax && window.MathJax.Hub && window.MathJax.Hub.Config) {window.MathJax.Hub.Config({SVG: {font: \"STIX-Web\"}});}\nif (typeof require !== 'undefined') {\nrequire.undef(\"plotly\");\nrequirejs.config({\n    paths: {\n        'plotly': ['https://cdn.plot.ly/plotly-2.35.2.min']\n    }\n});\nrequire(['plotly'], function(Plotly) {\n    window._Plotly = Plotly;\n});\n}\n</script>\n\n"
      ]
    }
  }
}